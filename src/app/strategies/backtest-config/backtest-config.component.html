<div class="backtest-config">
  @if (loading) {
    <div class="d-flex justify-content-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  } @else {
    <div class="row g-3">
      <!-- Date Range -->
      <div class="col-md-6">
        <label class="form-label">Start Date <span class="text-danger">*</span></label>
        <input type="date" class="form-control" [(ngModel)]="startDate" (ngModelChange)="onInputChange()">
      </div>
      <div class="col-md-6">
        <label class="form-label">End Date <span class="text-danger">*</span></label>
        <input type="date" class="form-control" [(ngModel)]="endDate" (ngModelChange)="onInputChange()">
      </div>

      <!-- Initial Capital -->
      <div class="col-md-6">
        <label class="form-label">Initial Capital ($)</label>
        <input type="number" class="form-control" [(ngModel)]="initialCapital"
               min="100" step="1000">
      </div>

      <!-- Data Coverage Hint -->
      @if (coverage) {
        <div class="col-12">
          <div class="coverage-hint">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4"/><path d="M12 8h.01"/>
            </svg>
            <span>
              Data available: {{ coverage.fromDate | date:'mediumDate' }} â€” {{ coverage.toDate | date:'mediumDate' }}
              ({{ coverage.candleCount | number }} candles)
            </span>
          </div>
        </div>
      }

      <!-- Optional Overrides -->
      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="showOverrides"
                 [(ngModel)]="showOverrides" (ngModelChange)="onInputChange()">
          <label class="form-check-label" for="showOverrides">Override strategy data source</label>
        </div>
      </div>

      @if (showOverrides) {
        <div class="col-md-4">
          <label class="form-label">Symbol</label>
          <input type="text" class="form-control" [(ngModel)]="overrideSymbol"
                 placeholder="Use strategy default" (ngModelChange)="onInputChange()">
        </div>
        <div class="col-md-4">
          <label class="form-label">Data Source</label>
          <input type="text" class="form-control" [(ngModel)]="overrideSource"
                 placeholder="Use strategy default" (ngModelChange)="onInputChange()">
        </div>
        <div class="col-md-4">
          <label class="form-label">Interval</label>
          <input type="text" class="form-control" [(ngModel)]="overrideInterval"
                 placeholder="Use strategy default" (ngModelChange)="onInputChange()">
        </div>
      }

      <!-- Data Verification Result -->
      @if (verification) {
        <div class="col-12">
          <div class="verification-result" [ngClass]="verificationStatusClass">
            <div class="verification-header">
              <span class="verification-icon">{{ verificationIcon }}</span>
              <span class="verification-message">{{ verification.message }}</span>
            </div>
            @if (verification.storedCandleCount > 0 || verification.expectedCandleCount > 0) {
              <div class="verification-details">
                @if (verification.storedCandleCount > 0) {
                  <span class="detail-item">
                    <strong>{{ verification.storedCandleCount | number }}</strong> stored candles
                  </span>
                }
                @if (verification.expectedCandleCount > 0) {
                  <span class="detail-item">
                    ~<strong>{{ verification.expectedCandleCount | number }}</strong> expected
                  </span>
                }
                @if (verification.canAutoFetch) {
                  <span class="detail-item auto-fetch-badge">auto-fetch enabled</span>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
      <button class="btn btn-outline-secondary" (click)="cancelled.emit()" [disabled]="running">Cancel</button>
      <button class="btn btn-outline-primary" (click)="verifyData()"
              [disabled]="verifying || running || !canVerify()">
        @if (verifying) {
          <span class="spinner-border spinner-border-sm me-1" role="status"></span>
          Checking...
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
            <path d="M21 3v5h-5"/>
          </svg>
          Verify Data
        }
      </button>
      <button class="btn btn-primary" (click)="runBacktest()" [disabled]="running || !canRunBacktest">
        @if (running) {
          <span class="spinner-border spinner-border-sm me-1" role="status"></span>
          Running...
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          Run Backtest
        }
      </button>
    </div>
  }
</div>