<div class="p-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h5 class="mb-1">Access Requests</h5>
      <p class="text-muted mb-0 small">
        @if (pendingCount > 0) {
          {{ pendingCount }} pending request{{ pendingCount !== 1 ? 's' : '' }}
        } @else {
          No pending requests
        }
      </p>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <!-- Status filter pills -->
      <div class="status-filter">
        @for (option of statusOptions; track option.value) {
          <button
            class="btn btn-sm"
            [class.btn-outline-secondary]="statusFilter() !== option.value"
            [class.btn-secondary]="statusFilter() === option.value"
            (click)="statusFilter.set(option.value)">
            {{ option.label }}
            @if (getCountForStatus(option.value) > 0) {
              <span class="badge bg-light text-dark ms-1">{{ getCountForStatus(option.value) }}</span>
            }
          </button>
        }
      </div>
      <button class="btn btn-sm btn-outline-secondary" (click)="loadRequests()" [disabled]="loading()">
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="text-center py-4">
      <div class="spinner-border spinner-border-sm text-muted" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  } @else if (filteredRequests.length === 0) {
    <div class="text-center py-5 text-muted">
      <p class="mb-0">No access requests found.</p>
    </div>
  } @else {
    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>IP Address</th>
            <th>Status</th>
            <th>Requested</th>
            <th>Reviewed</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (req of filteredRequests; track req.id) {
            <tr>
              <td>
                <span class="fw-medium">{{ req.firstName }} {{ req.lastName }}</span>
              </td>
              <td>
                <span class="text-muted small">{{ req.email }}</span>
              </td>
              <td>
                @if (req.ipAddress) {
                  <span class="ip-address">{{ req.ipAddress }}</span>
                } @else {
                  <span class="text-muted small">--</span>
                }
              </td>
              <td>
                <span class="badge" [ngClass]="getStatusBadgeClass(req.status)">
                  {{ getStatusLabel(req.status) }}
                </span>
              </td>
              <td>
                <span class="small">{{ formatDate(req.createdAt) }}</span>
              </td>
              <td>
                @if (req.reviewedAt) {
                  <span class="small">{{ formatDate(req.reviewedAt) }}</span>
                } @else {
                  <span class="text-muted small">--</span>
                }
              </td>
              <td class="text-end">
                <div class="action-buttons">
                  <button class="btn btn-sm btn-outline-warning" title="Review details"
                    (click)="openReviewModal(req, reviewModal)" [disabled]="processingId() === req.id">
                    <i class="bi bi-eye"></i>
                  </button>
                  @if (isPending(req.status)) {
                    <button class="btn btn-sm btn-outline-success" title="Approve"
                      (click)="approve(req.id)" [disabled]="processingId() === req.id">
                      @if (processingId() === req.id) {
                        <span class="spinner-border spinner-border-sm"></span>
                      } @else {
                        <i class="bi bi-check-lg"></i>
                      }
                    </button>
                    <button class="btn btn-sm btn-outline-danger" title="Reject"
                      (click)="openDenyModal(req.id, denyModal)" [disabled]="processingId() === req.id">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  }
                  <button class="btn btn-sm btn-outline-danger" title="Delete"
                    (click)="openDeleteModal(req.id, deleteModal)" [disabled]="processingId() === req.id">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Review Detail Modal -->
<ng-template #reviewModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Review Access Request</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body review-details">
    @if (reviewRequest(); as req) {
      <div class="row g-3">
        <div class="col-6">
          <div class="detail-label">Full Name</div>
          <div class="detail-value">{{ req.firstName }} {{ req.lastName }}</div>
        </div>
        <div class="col-6">
          <div class="detail-label">Email</div>
          <div class="detail-value">{{ req.email }}</div>
        </div>
        <div class="col-6">
          <div class="detail-label">IP Address</div>
          <div class="detail-value">{{ req.ipAddress || '--' }}</div>
        </div>
        <div class="col-6">
          <div class="detail-label">Status</div>
          <div class="detail-value">
            <span class="badge" [ngClass]="getStatusBadgeClass(req.status)">
              {{ getStatusLabel(req.status) }}
            </span>
          </div>
        </div>
        <div class="col-6">
          <div class="detail-label">Requested</div>
          <div class="detail-value">{{ formatDate(req.createdAt) }}</div>
        </div>
        <div class="col-6">
          <div class="detail-label">Email Verified</div>
          <div class="detail-value">
            @if (req.emailVerifiedAt) {
              <span class="text-success">{{ formatDate(req.emailVerifiedAt) }}</span>
            } @else {
              <span class="text-muted">Not verified</span>
            }
          </div>
        </div>
        @if (req.reviewedAt) {
          <div class="col-12">
            <div class="detail-label">Reviewed</div>
            <div class="detail-value">{{ formatDate(req.reviewedAt) }}</div>
          </div>
        }
        @if (req.denialReason) {
          <div class="col-12">
            <div class="detail-label">Denial Reason</div>
            <div class="denial-reason">{{ req.denialReason }}</div>
          </div>
        }
      </div>
    }
  </div>
  <div class="modal-footer">
    @if (reviewRequest(); as req) {
      @if (isPending(req.status)) {
        <button type="button" class="btn btn-sm btn-outline-danger"
          (click)="rejectFromReview(denyModal, modal)">Reject</button>
        <button type="button" class="btn btn-sm btn-success"
          (click)="approveFromReview(modal)">Approve</button>
      } @else {
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="modal.dismiss()">Close</button>
      }
    }
  </div>
</ng-template>

<!-- Deny Reason Modal -->
<ng-template #denyModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Deny Access Request</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <label for="denyReason" class="form-label">Reason (optional)</label>
    <textarea
      id="denyReason"
      class="form-control"
      rows="3"
      placeholder="Provide a reason for denying this request..."
      [(ngModel)]="denyReason"
    ></textarea>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-sm btn-danger" (click)="confirmDeny(modal)">Deny Request</button>
  </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #deleteModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Delete Access Request</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to permanently delete this access request? This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
    <button type="button" class="btn btn-sm btn-danger" (click)="confirmDelete(modal)">Delete</button>
  </div>
</ng-template>
